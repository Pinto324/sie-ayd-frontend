<div class="container mx-auto px-4 py-8">
    
    @if (viewMode === 'table') {
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-black">Gestión de Empleados</h1>
                <p class="text-gray-600 dark:text-black-300 mt-2">Administra el personal de reparto.</p>
            </div>

            <div class="flex gap-4 mt-4 md:mt-0">
                <app-searchtable placeholder="Buscar empleados por nombre o DNI..." [initialTerm]="searchTerm"
                    (searchChange)="onSearchChange($event)">
                </app-searchtable>

                <button (click)="openCreateModal()"
                    class="flex items-center gap-2 px-4 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-300 transition-colors">
                    <fa-icon [icon]="faPlus"></fa-icon>
                    Crear Empleado
                </button>
            </div>
        </div>

        <app-table [data]="filteredEmployees" [columns]="tableColumns" [actions]="tableActions"
            (actionClick)="handleTableAction($event)">
        </app-table>
    } @else if (viewMode === 'contracts' && selectedDeliveryPersonDetail) {
        <div class="mb-8">
            <button (click)="goBackToTable()"
                class="flex items-center gap-2 text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-white mb-6">
                <fa-icon [icon]="faArrowLeft"></fa-icon>
                Volver a la tabla de repartidores
            </button>
            <h1 class="text-3xl font-bold text-gray-900 dark:text-black flex items-center gap-3">
                <fa-icon [icon]="faFileContract" class="text-purple-600"></fa-icon>
                Contrato de {{ selectedDeliveryPersonDetail.firstname }} {{ selectedDeliveryPersonDetail.lastname }}
            </h1>
            <p class="text-gray-600 dark:text-black-300 mt-2">Detalle y acciones del contrato actual (ID: {{ selectedDeliveryPersonDetail.contract.id }})</p>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl overflow-hidden p-6 border border-gray-200 dark:border-gray-700">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm  p-8 border border-gray-300 rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <div>
                    <h3 class="text-lg font-semibold mb-2 text-gray-900 dark:text-white">Detalles Principales</h3>
                    <p class="text-gray-500 dark:text-gray-400">Tipo de Contrato:</p>
                    <p class="text-base font-medium">{{ selectedDeliveryPersonDetail.contract.contractType }}</p>
                    <hr class="my-2 border-gray-100 dark:border-gray-700">
                    <p class="text-gray-500 dark:text-gray-400">Salario Base:</p>
                    <p class="text-base font-medium text-green-600">${{ selectedDeliveryPersonDetail.contract.baseSalary | number: '1.2-2' }}</p>
                </div>

                <div>
                    <h3 class="text-lg font-semibold mb-2 text-gray-900 dark:text-white">Vigencia</h3>
                    <p class="text-gray-500 dark:text-gray-400">Inicio:</p>
                    <p class="text-base font-medium">{{ selectedDeliveryPersonDetail.contract.startDate | date: 'dd/MM/yyyy' }}</p>
                    <hr class="my-2 border-gray-100 dark:border-gray-700">
                    <p class="text-gray-500 dark:text-gray-400">Fin:</p>
                    <p class="text-base font-medium">{{ selectedDeliveryPersonDetail.contract.endDate | date: 'dd/MM/yyyy' }}</p>
                    <hr class="my-2 border-gray-100 dark:border-gray-700">
                    <p class="text-gray-500 dark:text-gray-400">Comisión (%):</p>
                    <p class="text-base font-medium">{{ selectedDeliveryPersonDetail.contract.commissionPercentage }}%</p>
                </div>

                <div>
                    <h3 class="text-lg font-semibold mb-2 text-gray-900 dark:text-white">Estado Actual</h3>
                    <p class="text-gray-500 dark:text-gray-400  my-2">Estatus:</p>
                    <span 
                        class="text-lg font-bold px-3 py-1 rounded-full"
                        [ngClass]="{
                            'bg-green-100 text-green-800': selectedDeliveryPersonDetail.contract.contractStatus === 'ACTIVO',
                            'bg-red-100 text-red-800': selectedDeliveryPersonDetail.contract.contractStatus !== 'ACTIVO'
                        }">
                        {{ selectedDeliveryPersonDetail.contract.contractStatus }}
                    </span>
                    <hr class="my-4 border-gray-100 dark:border-gray-700">
                    
                    <h3 class="text-lg font-semibold mb-2 text-gray-900 dark:text-white">Acciones</h3>
                    
                    @if (selectedDeliveryPersonDetail.contract.contractStatus === 'ACTIVO') {
                        <button (click)="executeContractBaja(selectedDeliveryPersonDetail.contract.id)"
                            class="w-full mt-2 flex items-center justify-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                            Dar de Baja
                        </button>
                    }
                    
                    @if (selectedDeliveryPersonDetail.contract.contractStatus === 'BAJA') {
                        <button (click)="openNewContractModal(selectedDeliveryPersonDetail.userId)"
                            class="w-full mt-2 flex items-center justify-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                            Nuevo Contrato
                        </button>
                    }

                    @if (selectedDeliveryPersonDetail.contract.contractStatus === 'ACTIVO' && isContractExpired(selectedDeliveryPersonDetail.contract.endDate)) {
                        <button (click)="openRenovateContractModal(selectedDeliveryPersonDetail.contract.id)"
                            class="w-full mt-2 flex items-center justify-center gap-2 px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors">
                            Renovar Contrato
                        </button>
                    }
                </div>
            </div>
        </div>

        @if (isLoadingData) {
            <div class="text-center p-6 mt-4 text-gray-500 bg-white dark:bg-gray-800 rounded-lg shadow-sm">
                Realizando acción...
            </div>
        }
    } @else if (viewMode === 'historial'){
        <app-historialpagos  [userId]="idEmpleadoHistorial" [idEmpleado]="idEmpleadoPagos" [isAdminUserSpecific]="true" (back)="goBackToTable()"
            
            >
            </app-historialpagos>
    }
    @if (viewMode === 'contracts' && selectedDeliveryPersonDetail) {

        <h2 class="text-2xl font-bold text-gray-900 dark:text-black mb-4 flex items-center gap-2">
            Historial de Contratos
        </h2>
        <p class="text-gray-600 dark:text-black-300 mb-4">
            Lista de contratos previos y su estado.
        </p>
        
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm overflow-hidden">
            @if (isLoadingData) {
                <div class="p-6 text-center text-gray-500">Cargando historial de contratos...</div>
            } @else if (contractHistory.length === 0) {
                <div class="p-6 text-center text-gray-500">No se encontró historial de contratos.</div>
            } @else {
                <app-table [data]="contractHistory" [columns]="historyColumns" [actions]="[]">
                </app-table>
            }
        </div>
        
    }
</div>

<app-alert 
  [isOpen]="isAlertModalOpen"
  [type]="alertType"
  [message]="alertMessage"
  (closed)="closeAlertModal()">
</app-alert>

<app-modal [isOpen]="isModalOpen" [title]="isEditMode ? 'Modificar Empleado' : 'Crear Nuevo Empleado'" size="lg"
    (close)="closeModal()">

    <div modal-body>
        <form [formGroup]="employeeForm" class="space-y-6">
            <!-- Datos Personales -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="firstname" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Nombre *</label>
                    <input type="text" formControlName="firstname" id="firstname"
                        class="w-full p-2.5 rounded-lg border border-gray-300 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                    @if (employeeForm.get('firstname')?.invalid && employeeForm.get('firstname')?.touched) {
                    <p class="mt-1 text-sm text-red-600">El nombre es requerido</p>
                    }
                </div>

                <div>
                    <label for="lastname" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Apellido *</label>
                    <input type="text" formControlName="lastname" id="lastname"
                        class="w-full p-2.5 rounded-lg border border-gray-300 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                    @if (employeeForm.get('lastname')?.invalid && employeeForm.get('lastname')?.touched) {
                    <p class="mt-1 text-sm text-red-600">El apellido es requerido</p>
                    }
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="dni" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">DNI *</label>
                    <input type="number" formControlName="dni" id="dni"
                        class="w-full p-2.5 rounded-lg border border-gray-300 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                    @if (employeeForm.get('dni')?.invalid && employeeForm.get('dni')?.touched) {
                    <p class="mt-1 text-sm text-red-600">El DNI es requerido</p>
                    }
                </div>

                <div>
                    <label for="phoneNumber" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Teléfono *</label>
                    <input type="text" formControlName="phoneNumber" id="phoneNumber"
                        class="w-full p-2.5 rounded-lg border border-gray-300 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                    @if (employeeForm.get('phoneNumber')?.invalid && employeeForm.get('phoneNumber')?.touched) {
                    <p class="mt-1 text-sm text-red-600">El teléfono es requerido</p>
                    }
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="birthDate" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Fecha de Nacimiento</label>
                    <input type="date" formControlName="birthDate" id="birthDate"
                        class="w-full p-2.5 rounded-lg border border-gray-300 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                </div>

                <div>
                    <label for="emergencyContact" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Contacto de Emergencia</label>
                    <input type="text" formControlName="emergencyContact" id="emergencyContact"
                        class="w-full p-2.5 rounded-lg border border-gray-300 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                </div>
            </div>

            <div>
                <label for="address" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Dirección</label>
                <textarea formControlName="address" id="address" rows="3"
                    class="w-full p-2.5 rounded-lg border border-gray-300 dark:bg-gray-600 dark:border-gray-500 dark:text-white"></textarea>
            </div>

            <!-- Solo mostrar campos de contrato en modo CREACIÓN -->
            @if (!isEditMode) {
            <div class="border-t pt-4 border-gray-300 dark:border-gray-600">
                <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Detalles del Contrato</h4>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="contractTypeId" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Tipo de Contrato *</label>
                        <select formControlName="contractTypeId" id="contractTypeId"
                            class="w-full p-2.5 rounded-lg border border-gray-300 dark:bg-gray-600 dark:border-gray-500 dark:text-white"
                            required>
                            <option [ngValue]="null" disabled>Seleccione un tipo</option>
                            @for (type of contractTypes; track type.id) {
                            <option [ngValue]="type.id">{{ type.name }}</option>
                            }
                        </select>
                        @if (employeeForm.get('contractTypeId')?.invalid && employeeForm.get('contractTypeId')?.touched) {
                        <p class="mt-1 text-sm text-red-600">El tipo de contrato es requerido</p>
                        }
                    </div>

                    <div>
                        <label for="baseSalary" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Salario Base *</label>
                        <input type="number" formControlName="baseSalary" id="baseSalary" min="0"
                            class="w-full p-2.5 rounded-lg border border-gray-300 dark:bg-gray-600 dark:border-gray-500 dark:text-white"
                            required>
                        @if (employeeForm.get('baseSalary')?.invalid && employeeForm.get('baseSalary')?.touched) {
                        <p class="mt-1 text-sm text-red-600">El salario base es requerido</p>
                        }
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="commissionPercentage" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Porcentaje de Comisión *</label>
                        <input type="number" formControlName="commissionPercentage" id="commissionPercentage" min="0" max="100"
                            class="w-full p-2.5 rounded-lg border border-gray-300 dark:bg-gray-600 dark:border-gray-500 dark:text-white"
                            required>
                        @if (employeeForm.get('commissionPercentage')?.invalid && employeeForm.get('commissionPercentage')?.touched) {
                        <p class="mt-1 text-sm text-red-600">La comisión es requerida (0-100%)</p>
                        }
                    </div>

                    <div>
                        <label for="endDate" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Fecha de Fin *</label>
                        <input type="date" formControlName="endDate" id="endDate"
                            class="w-full p-2.5 rounded-lg border border-gray-300 dark:bg-gray-600 dark:border-gray-500 dark:text-white"
                            required>
                        @if (employeeForm.get('endDate')?.invalid && employeeForm.get('endDate')?.touched) {
                        <p class="mt-1 text-sm text-red-600">La fecha de fin es requerida</p>
                        }
                    </div>
                </div>
            </div>
            }
        </form>
    </div>

    <div modal-footer class="flex justify-end w-full gap-2">
        <button (click)="closeModal()" type="button"
            class="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-blue-300 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-500 dark:hover:text-white dark:hover:bg-gray-600">
            Cancelar
        </button>
        <button (click)="onSubmit()" [disabled]="(!isEditMode && employeeForm.invalid) || isLoadingModal"
            class="text-white inline-flex items-center bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center disabled:opacity-50 disabled:cursor-not-allowed">
            @if (isLoadingModal) {
            Cargando...
            } @else {
            {{ isEditMode ? 'Modificar Empleado' : 'Crear Empleado' }}
            }
        </button>
    </div>

</app-modal>

<app-modal [isOpen]="isContractModalOpen" 
           [title]="contractModalMode === 'nuevo' ? 'Crear Nuevo Contrato' : 'Renovar Contrato Existente'" 
           size="md"
           (close)="closeContractModal()">

    <div modal-body>
        <form [formGroup]="contractForm" class="space-y-6">

            @if (contractModalMode === 'nuevo') {
                <h4 class="text-lg font-semibold text-gray-900 dark:text-white pt-2">Detalles del Nuevo Contrato</h4>
                <hr class="border-gray-300 dark:border-gray-600">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="contractTypeId"
                            class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Tipo de Contrato *</label>
                        <select formControlName="contractTypeId" id="contractTypeId"
                            class="w-full p-2.5 rounded-lg border border-gray-300 dark:bg-gray-600 dark:border-gray-500 dark:text-white"
                            required>
                            <option [ngValue]="null" disabled>Seleccione un tipo</option>
                            @for (type of contractTypes; track type.id) {
                                <option [ngValue]="type.id">{{ type.name }}</option>
                            }
                        </select>
                    </div>

                    <div>
                        <label for="baseSalary"
                            class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Salario Base *</label>
                        <input type="number" formControlName="baseSalary" id="baseSalary" min="0"
                            class="w-full p-2.5 rounded-lg border border-gray-300 dark:bg-gray-600 dark:border-gray-500 dark:text-white"
                            required>
                    </div>
                </div>

                <div>
                    <label for="commissionPercentage"
                        class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Porcentaje de Comisión *</label>
                    <input type="number" formControlName="commissionPercentage" id="commissionPercentage" min="0" max="100"
                        class="w-full p-2.5 rounded-lg border border-gray-300 dark:bg-gray-600 dark:border-gray-500 dark:text-white"
                        required>
                </div>
            }

            <div [ngClass]="{'border-t pt-4 border-gray-300 dark:border-gray-600': contractModalMode === 'renovar'}">
                <label for="endDateContract"
                    class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Fecha de Finalización *</label>
                <input type="date" formControlName="endDate" id="endDateContract"
                    class="w-full p-2.5 rounded-lg border border-gray-300 dark:bg-gray-600 dark:border-gray-500 dark:text-white"
                    required>
            </div>
            
        </form>
    </div>

    <div modal-footer class="flex justify-end w-full gap-2">
        <button (click)="closeContractModal()" type="button"
            class="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-blue-300 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-500 dark:hover:text-white dark:hover:bg-gray-600">
            Cancelar
        </button>
        <button (click)="onContractSubmit()" [disabled]="!contractForm.valid || isLoadingModal"
            class="text-white inline-flex items-center bg-purple-600 hover:bg-purple-700 focus:ring-4 focus:outline-none focus:ring-purple-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center disabled:opacity-50 disabled:cursor-not-allowed">
            @if (isLoadingModal) {
                Cargando...
            } @else {
                {{ contractModalMode === 'nuevo' ? 'Crear Contrato' : 'Renovar Contrato' }}
            }
        </button>
    </div>
</app-modal>

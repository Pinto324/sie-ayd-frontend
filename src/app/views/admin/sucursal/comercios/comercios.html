<div class="container mx-auto">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8">

        @if (viewMode === 'table') {
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-black">Gestión de Comercios</h1>
                <p class="text-gray-600 dark:text-black-300 mt-2">Administra los comercios ya registrados</p>
            </div>
            <div class="flex gap-4 mt-4 md:mt-0">
                <app-searchtable 
                    placeholder="Buscar comercios por nombre, NIT o email..." 
                    [initialTerm]="searchTerm"
                    (searchChange)="searchTerm = $event; searchCommerces();">
                </app-searchtable>
            </div>
        } @else {
            <div class="flex items-center">
                <button 
                    (click)="goBackToTable()"
                    class="flex items-center px-3 py-1 mb-4 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition-colors">
                    <fa-icon [icon]="faArrowLeft" class="mr-2"></fa-icon>
                    Volver
                </button>
            </div>
        }
    </div>

    @if (viewMode === 'table') {
        @if (isLoading) {
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm overflow-hidden p-6 text-center text-gray-500">
                Cargando comercios...
            </div>
        } @else if (errorMessage) {
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm overflow-hidden p-6 text-center text-red-500 border border-red-300">
                {{ errorMessage }}
            </div>
        } @else {
             <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <app-table 
                        [data]="filteredCommerces" 
                        [columns]="tableColumns" 
                        [actions]="tableActions"                        
                        (actionClick)="handleTableAction($event)">
                    </app-table>
                </div>
            </div>
        }
    } @else if (viewMode === 'fidelizacion') {
        <app-fidelizacioncomercio 
            [commerceId]="selectedCommerceId"
            [name]="nameCommerceId"> 
        </app-fidelizacioncomercio>
    } @else if (viewMode === 'caja') {
        <app-caja 
            [userId]="commerceForCajaId"
            [esComercio]="false"> 
        </app-caja>
    }

    @if (isModalOpen) {
        <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 transition-opacity duration-300 ease-out"
            (click)="closeModal()">
            <div class="relative bg-white rounded-lg shadow-2xl dark:bg-gray-700 w-full max-w-lg mx-4 my-8 transition-transform duration-300 ease-out transform scale-100 opacity-100"
                (click)="$event.stopPropagation()">
                <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600 border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                        Editar Comercio: {{ selectedCommerce?.name }}
                    </h3>
                    <button (click)="closeModal()" type="button"
                        class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white">
                        <fa-icon [icon]="faArrowLeft" class="w-3 h-3"></fa-icon>
                        <span class="sr-only">Cerrar modal</span>
                    </button>
                </div>
                <div class="p-4 md:p-5">
                    <form [formGroup]="commerceForm" (ngSubmit)="onSubmit()">
                        <div class="mb-4">
                            <label for="name" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Nombre</label>
                            <input type="text" formControlName="name" id="name" class="w-full p-2.5 rounded-lg border border-gray-300 dark:bg-gray-600 dark:border-gray-500 dark:text-white" placeholder="Nombre del comercio" required>
                        </div>
                        <div class="mb-4">
                            <label for="nit" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">NIT</label>
                            <input type="text" formControlName="nit" id="nit" class="w-full p-2.5 rounded-lg border border-gray-300 dark:bg-gray-600 dark:border-gray-500 dark:text-white" placeholder="Número de identificación tributaria" required>
                        </div>
                        <div class="mb-4">
                            <label for="address" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Dirección</label>
                            <input type="text" formControlName="address" id="address" class="w-full p-2.5 rounded-lg border border-gray-300 dark:bg-gray-600 dark:border-gray-500 dark:text-white" placeholder="Dirección del comercio" required>
                        </div>
                        <div class="mb-4">
                            <label for="phoneNumber" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Teléfono</label>
                            <input type="text" formControlName="phoneNumber" id="phoneNumber" class="w-full p-2.5 rounded-lg border border-gray-300 dark:bg-gray-600 dark:border-gray-500 dark:text-white" placeholder="Número de teléfono" required>
                        </div>
                         <div class="mb-4">
                            <label for="password" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Nueva Contraseña (Opcional)</label>
                            <input type="password" formControlName="password" id="password" class="w-full p-2.5 rounded-lg border border-gray-300 dark:bg-gray-600 dark:border-gray-500 dark:text-white" placeholder="Dejar vacío para no cambiar">
                        </div>
                         <div class="flex items-center space-x-4 mb-6">
                            <div class="flex items-center">
                                <input type="checkbox" formControlName="use2fa" id="use2fa" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                <label for="use2fa" class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">Doble factor de autenticación</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" formControlName="isActive" id="isActive" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                <label for="isActive" class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">Comercio habilitado</label>
                            </div>
                        </div>

                        <p class="text-xs text-yellow-600 dark:text-yellow-400 mb-4">
                            Para modificar el correo electrónico, rol o cualquier otro parámetro del usuario, hágalo desde el
                            módulo de usuarios.
                        </p>

                        <button type="submit" [disabled]="!commerceForm.valid"
                            class="text-white inline-flex items-center bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center disabled:opacity-50 disabled:cursor-not-allowed">
                            <fa-icon [icon]="faEdit" class="me-2"></fa-icon>
                            Guardar Cambios
                        </button>
                    </form>
                </div>
            </div>
        </div>
    }
</div>
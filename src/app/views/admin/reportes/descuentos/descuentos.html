<div class="space-y-6">

    <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-inner flex justify-end gap-3">
        <button (click)="exportToExcel()" class="flex items-center px-3 py-1.5 text-sm font-medium rounded-lg text-white bg-green-600 hover:bg-green-700 transition-colors shadow-sm" [disabled]="reports.length === 0">
            <fa-icon [icon]="faFileExport" class="mr-2"></fa-icon> Exportar Excel
        </button>
        <button (click)="exportToPdf()" class="flex items-center px-3 py-1.5 text-sm font-medium rounded-lg text-white bg-red-600 hover:bg-red-700 transition-colors shadow-sm" [disabled]="reports.length === 0">
            <fa-icon [icon]="faFileExport" class="mr-2"></fa-icon> Exportar PDF
        </button>
        <button (click)="exportToImage()" class="flex items-center px-3 py-1.5 text-sm font-medium rounded-lg text-white bg-yellow-600 hover:bg-yellow-700 transition-colors shadow-sm" [disabled]="reports.length === 0">
            <fa-icon [icon]="faFileExport" class="mr-2"></fa-icon> Exportar Imagen
        </button>
    </div>

    @if (isLoading) {
        <div class="text-center py-10 text-gray-500 dark:text-gray-400">Cargando datos del reporte de descuentos...</div>
    } @else if (reports.length === 0) {
        <div class="text-center py-10 text-gray-500 dark:text-gray-400 border border-dashed p-4 rounded-lg">
            No se encontraron descuentos aplicados.
        </div>
    } @else {
        <div [id]="reportContainerId" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            @for (report of reports; track report.id) {
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl border-t-4 border-purple-600 dark:border-purple-500">
                    
                    <div class="flex justify-between items-start mb-4 border-b pb-3 border-gray-200 dark:border-gray-700">
                        <div>
                            <span class="text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400">Comercio</span>
                            <h3 class="text-xl font-extrabold text-gray-900 dark:text-white mt-1 flex items-center">
                                <fa-icon [icon]="faStore" class="mr-2 text-purple-500"></fa-icon>
                                {{ report.commerce.name }}
                            </h3>
                            <span [class]="getLevelClass(report.fidelizationLevel)" class="mt-2 inline-flex items-center">
                                <fa-icon [icon]="faLevelUpAlt" class="mr-1"></fa-icon>
                                Nivel: {{ report.fidelizationLevel }}
                            </span>
                        </div>

                        <div class="text-right">
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Total Aplicado</span>
                            <p class="text-3xl font-bold text-red-600 dark:text-red-400 mt-1 flex items-center justify-end">
                                <fa-icon [icon]="faDollarSign" class="mr-2 text-2xl"></fa-icon>
                                ${{ report.totalAmount | number: '1.2-2' }}
                            </p>
                        </div>
                    </div>
                    
                    <div class="space-y-4 pt-2">
                        
                        <div class="border border-green-200 dark:border-green-800 p-3 rounded-md bg-green-50 dark:bg-gray-700">
                            <h4 class="font-bold text-md text-green-700 dark:text-green-300 flex items-center mb-2">
                                <fa-icon [icon]="faTruck" class="mr-2"></fa-icon> Descuento por Entregas ({{ report.deliveriesTotalCount }} guías)
                            </h4>
                            <dl class="text-sm space-y-1">
                                <div class="flex justify-between">
                                    <dt>Monto Bruto:</dt>
                                    <dd class="font-semibold text-gray-900 dark:text-white">${{ report.deliveriesTotalAmount | number: '1.2-2' }}</dd>
                                </div>
                                <div class="flex justify-between">
                                    <dt>Descuento Aplicado:</dt>
                                    <dd class="font-semibold text-red-500">{{ report.deliveriesApplyPercentage }}%</dd>
                                </div>
                                <div class="flex justify-between border-t border-green-300 dark:border-green-600 pt-1 mt-1">
                                    <dt class="font-bold">Monto Neto (Descontado):</dt>
                                    <dd class="font-extrabold text-green-600 dark:text-green-400">${{ report.deliveriesSubTotalAmount | number: '1.2-2' }}</dd>
                                </div>
                            </dl>
                        </div>
                        
                        <div class="border border-red-200 dark:border-red-800 p-3 rounded-md bg-red-50 dark:bg-gray-700">
                            <h4 class="font-bold text-md text-red-700 dark:text-red-300 flex items-center mb-2">
                                <fa-icon [icon]="faBan" class="mr-2"></fa-icon> Descuento por Cancelaciones ({{ report.cancelledTotalCount }} guías)
                            </h4>
                            <dl class="text-sm space-y-1">
                                <div class="flex justify-between">
                                    <dt>Monto Bruto:</dt>
                                    <dd class="font-semibold text-gray-900 dark:text-white">${{ report.cancelledTotalAmount | number: '1.2-2' }}</dd>
                                </div>
                                <div class="flex justify-between">
                                    <dt>Descuento Aplicado:</dt>
                                    <dd class="font-semibold text-red-500">{{ report.cancelledApplyPercentage }}%</dd>
                                </div>
                                <div class="flex justify-between border-t border-red-300 dark:border-red-600 pt-1 mt-1">
                                    <dt class="font-bold">Monto Neto (Descontado):</dt>
                                    <dd class="font-extrabold text-green-600 dark:text-green-400">${{ report.cancelledSubTotalAmount | number: '1.2-2' }}</dd>
                                </div>
                            </dl>
                        </div>

                    </div>

                    <div class="mt-4 pt-3 border-t border-gray-100 dark:border-gray-700 text-xs text-gray-500 dark:text-gray-400 flex justify-between items-center">
                        <span>Registro Creado: {{ report.createdDate | date:'dd/MM/yyyy' }}</span>
                        <span [class]="report.status === 'APLICADO' ? 'text-green-500 font-bold' : 'text-gray-500'">
                            Estado: {{ report.status }}
                        </span>
                    </div>
                </div>
            }
        </div>
    }
</div>
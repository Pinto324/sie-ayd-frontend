<div class="space-y-6">

    <div class="p-6 bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-100 dark:border-gray-700">
        <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
            <fa-icon [icon]="faCalendarDays" class="mr-3 text-blue-500"></fa-icon>
            Filtro de Período para Ranking
        </h3>

        <form (ngSubmit)="loadRankingReports()" class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
            <div>
                <label for="startDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Desde:</label>
                <input type="date" id="startDate" name="startDate" [(ngModel)]="filterData.startDate"
                    class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            
            <div>
                <label for="endDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Hasta:</label>
                <input type="date" id="endDate" name="endDate" [(ngModel)]="filterData.endDate"
                    class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white focus:ring-blue-500 focus:border-blue-500" required>
            </div>

            <button type="submit" [disabled]="isLoading"
                class="flex items-center justify-center h-10 px-4 py-2 text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 transition-colors shadow-md disabled:bg-blue-400">
                <fa-icon [icon]="faSearch" class="mr-2"></fa-icon> 
                {{ isLoading ? 'Buscando...' : 'Generar Ranking' }}
            </button>
        </form>
    </div>

    @if (hasSearched && !isLoading) {

        <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-inner flex justify-between items-center">
            <h4 class="text-gray-700 dark:text-gray-300 text-lg font-medium">
                Comercios analizados: <span class="font-bold text-blue-600 dark:text-blue-400">{{ reports.length }}</span>
            </h4>
            
            <div class="flex gap-3">
                <button (click)="exportToExcel()" class="flex items-center px-3 py-1.5 text-sm font-medium rounded-lg text-white bg-green-600 hover:bg-green-700 transition-colors shadow-sm" [disabled]="reports.length === 0">
                    <fa-icon [icon]="faFileExport" class="mr-2"></fa-icon> Excel
                </button>
                <button (click)="exportToPdf()" class="flex items-center px-3 py-1.5 text-sm font-medium rounded-lg text-white bg-red-600 hover:bg-red-700 transition-colors shadow-sm" [disabled]="reports.length === 0">
                    <fa-icon [icon]="faFileExport" class="mr-2"></fa-icon> PDF
                </button>
                <button (click)="exportToImage()" class="flex items-center px-3 py-1.5 text-sm font-medium rounded-lg text-white bg-yellow-600 hover:bg-yellow-700 transition-colors shadow-sm" [disabled]="reports.length === 0">
                    <fa-icon [icon]="faFileExport" class="mr-2"></fa-icon> Imagen
                </button>
            </div>
        </div>
    }

    @if (isLoading) {
        <div class="text-center py-10 text-gray-500 dark:text-gray-400">Calculando ranking de comercios...</div>
    } @else if (hasSearched && reports.length === 0) {
        <div class="text-center py-10 text-gray-500 dark:text-gray-400 border border-dashed p-4 rounded-lg">
            No se encontraron datos de entregas para generar el ranking en el período seleccionado.
        </div>
    } @else if (reports.length > 0) {
                <div  [id]="reportContainerId">
        <div class="p-4 bg-white dark:bg-gray-800 rounded-xl shadow-lg space-y-4">
            <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
                <fa-icon [icon]="faTrophy" class="mr-3 text-yellow-500"></fa-icon>
                Ranking de Comercios ({{ filterData.startDate }} a {{ filterData.endDate }})
            </h3>

            @for (report of reports; track report.nit) {
                @if ($index < 3) {
                    <div class="p-4 rounded-lg shadow-md transition-all duration-300"
                        [class]="{'bg-yellow-50 border-2 border-yellow-500 dark:bg-gray-700': $index === 0, 
                                 'bg-gray-50 border-2 border-gray-400 dark:bg-gray-700': $index === 1,
                                 'bg-amber-50 border-2 border-amber-500 dark:bg-gray-700': $index === 2}">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <span class="text-3xl font-extrabold text-white w-10 h-10 flex items-center justify-center rounded-full"
                                    [class]="{'bg-yellow-500': $index === 0, 'bg-gray-500': $index === 1, 'bg-amber-600': $index === 2}">
                                    {{ $index + 1 }}
                                </span>
                                
                                <div>
                                    <p class="text-xl font-bold text-gray-900 dark:text-white">{{ report.firstname }}</p>
                                    <div class="text-sm text-gray-500 dark:text-gray-400 space-x-3 flex">
                                        <p><fa-icon [icon]="faIdCard" class="mr-1"></fa-icon> NIT: {{ report.nit }}</p>
                                        <p><fa-icon [icon]="faMapMarkerAlt" class="mr-1"></fa-icon> {{ report.address }}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="text-right">
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Volumen Entregas</span>
                                <p class="text-3xl font-bold text-blue-600 dark:text-blue-400 mt-1 flex items-center justify-end">
                                    {{ report.deliveries | number }} <fa-icon [icon]="faTruck" class="ml-2 text-2xl"></fa-icon>
                                </p>
                            </div>
                        </div>
                    </div>
                } @else {
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-600">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <span class="text-xl font-bold text-gray-500 dark:text-gray-400 w-10 text-center">{{ $index + 1 }}</span>
                                <div>
                                    <p class="text-lg font-semibold text-gray-900 dark:text-white">{{ report.firstname }}</p>
                                    <span class="text-xs text-gray-500 dark:text-gray-400">{{ report.address }}</span>
                                </div>
                            </div>
                            <div class="w-1/3">
                                <div class="h-2.5 bg-gray-200 rounded-full dark:bg-gray-600">
                                    <div class="h-2.5 rounded-full bg-blue-600" [style.width]="getBarWidth(report.deliveries)"></div>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-xl font-bold text-blue-600 dark:text-blue-400">{{ report.deliveries | number }}</p>
                                <span class="text-xs text-gray-500 dark:text-gray-400">Entregas</span>
                            </div>
                        </div>
                    </div>
                }
            }
        </div>
        </div>
    }
</div>